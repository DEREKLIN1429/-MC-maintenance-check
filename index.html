function doPost(e) {
  try {
    // 1. 取得前端傳來的資料
    var data = JSON.parse(e.postData.contents);
    var note = data.note;
    var imageBase64 = data.image;
    
    // 如果前端沒有傳送 folderId，則使用此預設值 (你指定的新 Folder ID)
    var folderId = data.folderId || "1MCaCvWS73lyPd90yMXnDrD5BqiEw7O08"; 

    var imageCell = ""; 
    var fileName = "";  

    // 2. 處理圖片
    if (imageBase64 && imageBase64 !== "") {
      var contentType = imageBase64.substring(5, imageBase64.indexOf(';'));
      var base64Content = imageBase64.substring(imageBase64.indexOf(',') + 1);
      
      fileName = "Photo_" + Utilities.formatDate(new Date(), "GMT+8", "yyyyMMddHHmmss") + ".jpg";
      
      var blob = Utilities.newBlob(Utilities.base64Decode(base64Content), contentType, fileName);
      
      var folder;
      try {
        folder = DriveApp.getFolderById(folderId);
      } catch(err) {
        folder = DriveApp.getRootFolder();
      }
      var file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      
      var viewUrl = file.getUrl(); 
      var fileId = file.getId();
      var directUrl = "https://drive.google.com/uc?export=view&id=" + fileId; 
      
      imageCell = '=HYPERLINK("' + viewUrl + '", IMAGE("' + directUrl + '", 1))';
    }

    // 3. 存入 Google Sheet (已更新為你的新 ID)
    var sheetId = "1GcnAkIHAhnVjrH9bO9TQbdTUwQT17XtyQWUPh7WSTLA"; 
    var sheet = SpreadsheetApp.openById(sheetId).getSheets()[0]; 
    
    sheet.appendRow([new Date(), imageCell, note, fileName]);
    
    // 設定樣式
    var lastRow = sheet.getLastRow();
    sheet.setRowHeight(lastRow, 150); 
    sheet.setColumnWidth(2, 230); 

    return ContentService.createTextOutput(JSON.stringify({ "status": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
